# Деплой приложения в Google Cloud Run

Данная документация описывает процесс деплоя приложения Docmost в Google Cloud Run.

## Обзор

Скрипт `deploy.sh` автоматизирует процесс деплоя приложения в Cloud Run. Он обновляет только Docker образ приложения, **не затрагивая инфраструктуру** (переменные окружения, Cloud SQL, Redis, VPC и другие настройки).

## Требования

- **gcloud CLI** установлен и настроен
- **Docker** установлен и запущен
- Авторизация в GCP выполнена: `gcloud auth login`
- Доступ к проекту `docmost-484110`
- Права на запись в Artifact Registry репозиторий `docmost-repo`

## Конфигурация

Скрипт использует следующие настройки (определены в `deploy.sh`):

- **Проект GCP**: `docmost-484110`
- **Регион**: `europe-west1`
- **Сервис Cloud Run**: `docmost`
- **Репозиторий образов**: `docmost-repo` в Artifact Registry
- **Имя образа**: `docmost`
- **URL сервиса**: `https://docmost-dgv5ntd7ma-ew.a.run.app`

## Процесс деплоя

### Стандартный деплой

После внесения изменений в код выполните:

```bash
./deploy.sh
```

Это выполнит следующие шаги:

1. **Проверка авторизации** в GCP
2. **Сборка Docker образа** для платформы `linux/amd64` (требуется для Cloud Run)
3. **Загрузка образа** в Artifact Registry
4. **Деплой в Cloud Run** с обновлением только образа

**Важно**: Все настройки инфраструктуры (переменные окружения, Cloud SQL, Redis, VPC) сохраняются автоматически.

### Деплой с кастомным тегом

```bash
./deploy.sh --tag v1.2.3
```

Создаст образ с указанным тегом вместо `latest`.

### Пропуск сборки

Если образ уже собран локально:

```bash
./deploy.sh --no-build
```

Пропустит этап сборки и сразу загрузит существующий образ.

## Дополнительные команды

### Просмотр всех ревизий

```bash
./deploy.sh --list-revisions
```

Показывает список всех ревизий Cloud Run сервиса с их статусами и датами создания.

### Откат на предыдущую версию

Автоматический откат на предыдущую активную ревизию:

```bash
./deploy.sh --rollback
```

Откат на конкретную ревизию:

```bash
./deploy.sh --rollback docmost-00031-h2h
```

### Просмотр логов

```bash
gcloud run services logs read docmost --region europe-west1 --limit 50
```

## Что происходит при деплое

### 1. Сборка образа

- Используется `Dockerfile` с явно указанной платформой `linux/amd64`
- Собираются все приложения (server, client, editor-ext)
- Устанавливаются production зависимости
- Создается оптимизированный образ для Cloud Run

### 2. Загрузка образа

- Образ загружается в Artifact Registry
- Автоматическая авторизация через `gcloud auth configure-docker`

### 3. Деплой в Cloud Run

- Обновляется только Docker образ
- **Сохраняются автоматически**:
  - Переменные окружения
  - Подключения к Cloud SQL (PostgreSQL)
  - Подключения к Redis
  - Настройки VPC
  - Лимиты ресурсов (CPU, память)
  - Автомасштабирование
  - Health checks
  - Доменные маппинги

## Важные особенности

### Архитектура образа

Образ **обязательно** должен быть собран для платформы `linux/amd64`, так как Cloud Run использует эту архитектуру. Это настроено в:

- `Dockerfile`: `FROM --platform=linux/amd64 node:22-slim`
- `deploy.sh`: `docker build --platform linux/amd64`

### Порт приложения

Приложение использует переменную окружения `PORT`, которую Cloud Run устанавливает автоматически. В коде:

```typescript
const port = process.env.PORT || 3000;
```

Cloud Run автоматически устанавливает `PORT=8080` (или другое значение), и приложение слушает на этом порту.

### Безопасность инфраструктуры

Скрипт **не изменяет** настройки инфраструктуры. При деплое обновляется только образ приложения. Это означает:

- ✅ Переменные окружения остаются без изменений
- ✅ Подключения к базам данных сохраняются
- ✅ Настройки сети не затрагиваются
- ✅ Лимиты ресурсов не меняются

## Типичный workflow

1. **Внесите изменения** в код приложения
2. **Сохраните файлы**
3. **Запустите деплой**:
   ```bash
   ./deploy.sh
   ```
4. **Дождитесь завершения** (5-10 минут)
5. **Проверьте результат** на https://wiki.megatools.janado.de

## Устранение проблем

### Ошибка "exec format error"

Если видите ошибку `exec format error` в логах Cloud Run, это означает, что образ собран для неправильной архитектуры. Убедитесь, что:

- В `Dockerfile` указано `--platform=linux/amd64`
- В `deploy.sh` используется `--platform linux/amd64`

### Ошибка авторизации

```bash
gcloud auth login
gcloud auth configure-docker europe-west1-docker.pkg.dev
```

### Проверка статуса деплоя

```bash
./deploy.sh --list-revisions
gcloud run services describe docmost --region europe-west1
```

### Просмотр детальных логов

```bash
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=docmost" --limit 50 --project docmost-484110
```

## Время выполнения

- **Сборка образа**: 5-10 минут (зависит от размера проекта и скорости интернета)
- **Загрузка образа**: 2-5 минут
- **Деплой в Cloud Run**: 1-2 минуты
- **Общее время**: ~8-17 минут

## Полезные ссылки

- [Документация Cloud Run](https://cloud.google.com/run/docs)
- [Документация Artifact Registry](https://cloud.google.com/artifact-registry/docs)
- [Troubleshooting Cloud Run](https://cloud.google.com/run/docs/troubleshooting)

## Примечания

- Скрипт использует `set -e`, что означает остановку при любой ошибке
- Все команды логируются для отладки
- При успешном деплое выводится URL сервиса и полезные команды
